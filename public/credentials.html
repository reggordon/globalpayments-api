<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credential Management - Global Payments</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/credentials.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”‘ Credential Management</h1>
            <p>Temporarily override default credentials for your session</p>
        </header>

        <nav class="nav-links">
            <a href="/" style="font-weight: bold; text-decoration: underline;">ğŸ”‘ Credentials</a>
            <a href="/payment">ğŸ’³ Direct Payment</a>
            <a href="/hpp-options.html">ğŸ” HPP Options</a>
            <a href="/transactions.html">ğŸ“Š API Transactions</a>
            <a href="/hpp-transactions.html">ğŸ“Š HPP Transactions</a>
            <a href="/stored-cards.html">ğŸ’¾ Stored Cards</a>
        </nav>

        <div class="alert alert-info">
            <strong>â„¹ï¸ Session-Based Credentials:</strong> Any credentials you set here will only affect your current browser session. 
            They will be reset when you click "Reset to Defaults" or when your session expires.
        </div>

        <div class="alert alert-warning" id="currentStatus" style="display: none;">
            <strong>âœ“ Custom Credentials Active</strong><br>
            You are currently using custom credentials for this session.
        </div>

        <form id="credentialsForm">
            <div class="credentials-grid">
                <div class="credentials-section">
                    <h2>ğŸ’³ API Credentials</h2>
                    <p class="section-description">Direct Integration - Server-to-server payment processing</p>
                    
                    <div class="form-group">
                        <label for="apiMerchantId">Merchant ID:</label>
                        <input type="text" id="apiMerchantId" name="apiMerchantId" placeholder="Your API Merchant ID">
                        <small>Example: merchant12345</small>
                    </div>

                    <div class="form-group">
                        <label for="apiAccount">Account:</label>
                        <input type="text" id="apiAccount" name="apiAccount" placeholder="internet">
                        <small>Usually "internet"</small>
                    </div>

                    <div class="form-group">
                        <label for="apiSharedSecret">Shared Secret:</label>
                        <input type="password" id="apiSharedSecret" name="apiSharedSecret" placeholder="Your API Shared Secret">
                        <small>Keep this secret</small>
                        <button type="button" class="toggle-password" onclick="togglePassword('apiSharedSecret')">ğŸ‘ï¸ Show</button>
                    </div>
                </div>

                <div class="credentials-section">
                    <h2>ğŸ” HPP Credentials</h2>
                    <p class="section-description">Hosted Payment Page - Redirect and iframe methods</p>

                    <div class="form-group">
                        <label for="hppMerchantId">Merchant ID:</label>
                        <input type="text" id="hppMerchantId" name="hppMerchantId" placeholder="Your HPP Merchant ID">
                        <small>May differ from API</small>
                    </div>

                    <div class="form-group">
                        <label for="hppAccount">Account:</label>
                        <input type="text" id="hppAccount" name="hppAccount" placeholder="internet">
                        <small>Usually "internet"</small>
                    </div>

                    <div class="form-group">
                        <label for="hppSharedSecret">Shared Secret:</label>
                        <input type="password" id="hppSharedSecret" name="hppSharedSecret" placeholder="Your HPP Shared Secret">
                        <small>Keep this secret</small>
                        <button type="button" class="toggle-password" onclick="togglePassword('hppSharedSecret')">ğŸ‘ï¸ Show</button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" class="btn btn-primary">ğŸ’¾ Set Session Credentials</button>
                <button type="button" class="btn btn-secondary" onclick="resetCredentials()">ğŸ”„ Reset to Defaults</button>
            </div>
        </form>

        <div class="info-grid">
            <div class="info-card">
                <h3>ğŸ“‹ How It Works</h3>
                <ul>
                    <li><strong>Session-Only:</strong> Stored in your session only</li>
                    <li><strong>Private:</strong> Independent per user</li>
                    <li><strong>Temporary:</strong> Resets on logout or expire</li>
                    <li><strong>Secure:</strong> Never logged or exposed</li>
                    <li><strong>Testing:</strong> Perfect for merchant testing</li>
                </ul>
            </div>

            <div class="info-card">
                <h3>ğŸ¯ Use Cases</h3>
                <ul>
                    <li>Test multiple merchant accounts</li>
                    <li>Demo with client credentials</li>
                    <li>Switch sandbox/production</li>
                    <li>Team members use own credentials</li>
                </ul>
            </div>

            <div class="info-card">
                <h3>âš ï¸ Important Notes</h3>
                <ul>
                    <li>Defaults from <code>.env</code> file</li>
                    <li>Session overrides, doesn't modify <code>.env</code></li>
                    <li>API and HPP often differ</li>
                    <li>All fields are optional</li>
                </ul>
            </div>
        </div>

        <div id="messageBox" class="message" style="display: none;"></div>
    </div>

    <script src="js/theme-switcher.js"></script>
    <script>
        // Check if custom credentials are active
        async function checkCredentialStatus() {
            try {
                const response = await fetch('/api/credentials/status');
                const data = await response.json();
                
                if (data.usingCustomCredentials) {
                    document.getElementById('currentStatus').style.display = 'block';
                }
            } catch (err) {
                console.error('Error checking credential status:', err);
            }
        }

        // Set custom credentials
        document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                apiMerchantId: document.getElementById('apiMerchantId').value,
                apiAccount: document.getElementById('apiAccount').value,
                apiSharedSecret: document.getElementById('apiSharedSecret').value,
                hppMerchantId: document.getElementById('hppMerchantId').value,
                hppAccount: document.getElementById('hppAccount').value,
                hppSharedSecret: document.getElementById('hppSharedSecret').value
            };

            // Remove empty fields
            Object.keys(formData).forEach(key => {
                if (!formData[key]) delete formData[key];
            });

            if (Object.keys(formData).length === 0) {
                showMessage('Please enter at least one credential to override.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/credentials/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('âœ“ Custom credentials set successfully! These will be used for your session.', 'success');
                    document.getElementById('currentStatus').style.display = 'block';
                } else {
                    showMessage('Error: ' + (data.message || 'Failed to set credentials'), 'error');
                }
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        });

        // Reset to default credentials
        async function resetCredentials() {
            if (!confirm('Reset to default credentials from .env file?')) {
                return;
            }

            try {
                const response = await fetch('/api/credentials/reset', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('âœ“ Credentials reset to defaults. Using .env configuration.', 'success');
                    document.getElementById('currentStatus').style.display = 'none';
                    document.getElementById('credentialsForm').reset();
                } else {
                    showMessage('Error: ' + (data.message || 'Failed to reset credentials'), 'error');
                }
            } catch (err) {
                showMessage('Error: ' + err.message, 'error');
            }
        }

        // Toggle password visibility
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'ğŸ™ˆ Hide';
            } else {
                field.type = 'password';
                button.textContent = 'ğŸ‘ï¸ Show';
            }
        }

        // Show message
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'message ' + type;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Check status on page load
        checkCredentialStatus();
    </script>
</body>
</html>
